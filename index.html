<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Customer Behavior Dashboard</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#0b1220;
  color:#e6edf3;
}
header {
  padding:20px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
h1 { margin:0; }
.container { padding:20px; }
.plot { height:400px; margin-bottom:40px; }
select, input { margin-right:10px; padding:6px; }
</style>
</head>

<body>

<header>
  <h1>Customer Behavior Dashboard</h1>
  <p>Auto-loaded dataset + optional JSON upload</p>
</header>

<div class="container">
  <input type="file" id="fileInput" accept=".json" />
  <select id="category">
    <option value="__all__">All Categories</option>
  </select>
</div>

<div id="plot_scatter" class="plot"></div>
<div id="plot_heatmap" class="plot"></div>
<div id="plot_segment" class="plot"></div>
<div id="plot_subscription" class="plot"></div>
<div id="plot_map" class="plot"></div>

<script>

let RAW = [];
let FILTERED = [];

function toNum(v){
  const n = Number(v);
  return isNaN(n) ? null : n;
}

function uniq(arr){
  return [...new Set(arr.filter(Boolean))];
}

function applyFilters(){
  const cat = document.getElementById("category").value;
  FILTERED = RAW.filter(r => {
    if(cat !== "__all__" && r.category !== cat) return false;
    return true;
  });
}

function renderScatter(){
  const categories = uniq(FILTERED.map(r=>r.category));
  const traces = categories.map(cat=>{
    const rows = FILTERED.filter(r=>r.category===cat);
    return {
      x: rows.map(r=>toNum(r.purchase_amount)),
      y: rows.map(r=>toNum(r.review_rating)),
      mode:'markers',
      type:'scatter',
      name:cat
    }
  });
  Plotly.newPlot("plot_scatter", traces, {title:"Purchase vs Rating"});
}

function renderHeatmap(){
  const categories = uniq(FILTERED.map(r=>r.category));
  const seasons = uniq(FILTERED.map(r=>r.season));
  const z = categories.map(cat=>{
    return seasons.map(sea=>{
      return FILTERED.filter(r=>r.category===cat && r.season===sea).length;
    });
  });
  Plotly.newPlot("plot_heatmap", [{
    z:z,
    x:seasons,
    y:categories,
    type:'heatmap'
  }], {title:"Seasonal Demand"});
}

function renderSegment(){
  const ages = uniq(FILTERED.map(r=>r.age_group));
  const freqs = uniq(FILTERED.map(r=>r.frequency_of_purchases));
  const traces = freqs.map(f=>{
    return {
      x:ages,
      y:ages.map(a=>FILTERED.filter(r=>r.age_group===a && r.frequency_of_purchases===f).length),
      type:'bar',
      name:f
    }
  });
  Plotly.newPlot("plot_segment", traces, {barmode:'group', title:"Age vs Frequency"});
}

function renderSubscription(){
  const yes = FILTERED.filter(r=>r.subscription_status==="Yes");
  const no = FILTERED.filter(r=>r.subscription_status==="No");
  Plotly.newPlot("plot_subscription", [
    {y:yes.map(r=>toNum(r.purchase_amount)), type:'box', name:'Yes'},
    {y:no.map(r=>toNum(r.purchase_amount)), type:'box', name:'No'}
  ], {title:"Subscribers vs Non-Subscribers"});
}

function renderMap(){
  const states = uniq(FILTERED.map(r=>r.location));
  const z = states.map(s=>{
    return FILTERED.filter(r=>r.location===s)
      .reduce((sum,r)=>sum+(toNum(r.purchase_amount)||0),0);
  });
  Plotly.newPlot("plot_map", [{
    type:'choropleth',
    locationmode:'USA-states',
    locations:states,
    z:z
  }], {geo:{scope:'usa'}, title:"Revenue by State"});
}

function renderAll(){
  applyFilters();
  renderScatter();
  renderHeatmap();
  renderSegment();
  renderSubscription();
  renderMap();
}

function populateFilters(){
  const cats = uniq(RAW.map(r=>r.category));
  const select = document.getElementById("category");
  select.innerHTML='<option value="__all__">All Categories</option>';
  cats.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    select.appendChild(opt);
  });
}

document.getElementById("category").addEventListener("change", renderAll);

document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const file=e.target.files[0];
  if(!file) return;
  const text=await file.text();
  RAW=JSON.parse(text);
  populateFilters();
  renderAll();
});

// AUTO LOAD DEFAULT DATA
window.addEventListener("load", async ()=>{
  try{
    const response=await fetch("converted-data.json");
    RAW=await response.json();
    populateFilters();
    renderAll();
    console.log("Default dataset loaded");
  }catch(err){
    console.log("Auto-load failed",err);
  }
});

</script>

</body>
</html>

